# Runnables for locket (usable with `runnables-cli`)

[build]
description = "cargo build (release)"
cmd = "cargo build --release"

[test]
description = "cargo test"
cmd = "cargo test --features testing"

[fmt]
description = "cargo fmt --all"
cmd = "cargo fmt --all"

[clippy]
description = "cargo clippy -- -D warnings"
cmd = "cargo clippy --all-targets -- -D warnings"

[docker-build]
description = "docker build dev image"
path = "docker"
cmd = "VERSION=$(cargo run --quiet -- --version | cut -d' ' -f2)-dev docker buildx bake --allow=fs.read=.. -f docker-bake.hcl all --load --metadata-file ./bake-meta.json && ./build-plugin.sh ./bake-meta.json"

[docker-op]
path = "docker"
cmd = "docker compose -f compose.test.yaml up"

[docker-test-dbg]
description = "Run test of docker image"
cmd = "docker compose -f compose.debug.yaml run --remove-orphans --rm --entrypoint /bin/sh locket"

[docker-test]
description = "Run test of docker image"
path = "docker/tests/sidecar"
cmd = "docker compose -f compose.tests.yaml -p tests up"

[docker-plugin-config]
cmd = 'docker plugin disable -f bpbradley/locket:plugin && docker plugin set bpbradley/locket:plugin config.source="/etc/locket" && docker plugin enable bpbradley/locket:plugin'

[docker-provider]
description = "Run test of docker provider"
path = "docker/tests/provider"
cmd = "docker compose --verbose -p provider up"

[release-rc]
description = "Create a release candidate from the current version"
cmd = "cargo release rc --execute --no-publish"

[release-promote]
description = "Promote a release candidate to a full release and push"
cmd = "cargo release release --execute"

[release-patch]
description = "Bump patch version and execute release"
cmd = "cargo release patch --execute"

[release-minor]
description = "Bump minor version and execute release"
cmd = "cargo release minor --execute"

[release-major]
description = "Bump major version and execute release"
cmd = "cargo release major --execute"

[docs]
description = "Generate clap derived docs"
cmd = "cargo xtask docs"

[clean]
description = "Clean locket outputs"
cmd = "rm -rf ./secrets/op/out ./secrets/bws/out ./secrets/infisical/out"
